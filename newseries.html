<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script>
            let args=JSON.parse(decodeURIComponent(location.search.substring(1)));
            function argspack(pack){
                return encodeURIComponent(JSON.stringify({
                    collab:args["clb-collab-id"],
                    token:args.token,
                    ...pack
                }));
            };
            
            let filename="";
            function filtername(event){
                filename=event.target.value=event.target.value.replaceAll(/[^-\w().!]/g, "");
                trybutton();
            }
            let collecting=false;
            let recollect=false;
            let collection=[];
            let bucket;
            async function trycollect(event){
                if(collecting){
                    recollect=true;
                    return;
                }
                prg=document.getElementById("log");

                collecting=true;
                let list=collection=[];
                
                try{
                    bucket=event.target.value.replaceAll(/[^-\w().!]/g, "");
                    let result=await fetch(`bucket_fast.php?${argspack({filename:bucket+"?delimiter=/"})}`).then(response => response.json());
                    if(result.hasOwnProperty("objects")){
                        let images=result.objects.filter(item=>item.hasOwnProperty("subdir"));
                        for(let image of images){
                            prg.innerText="Fetching DZI "+(list.length+1)+"/"+images.length;
                            let subdir=image.subdir;
                            let pos=subdir.lastIndexOf(".");
                            let name=subdir.substring(0,pos);
                            let dzi=await fetch(`bucket_fast.php?${argspack({filename:bucket+"/"+subdir+name+".dzi"})}`)
                                    .then(response=>response.json())
                                    .then(json=>fetch(json.url))
                                    .then(response=>response.text());
                            list.push({
                                filename:subdir.substring(0,subdir.length-1),
                                width:parseInt(dzi.match(/Width="(\d+)"/m)[1]),
                                height:parseInt(dzi.match(/Height="(\d+)"/m)[1]),
                                tilesize:parseInt(dzi.match(/TileSize="(\d+)"/m)[1]),
                                overlap:parseInt(dzi.match(/Overlap="(\d+)"/m)[1]),
                                format:dzi.match(/Format="([^"]+)"/m)[1]
                            });
                        }
                    }
                }catch(ex){console.log(ex);}
                
                collecting=false;
                if(recollect){
                    recollect=false;
                    trycollect(event);
                }else{
                    collection=list;
                    prg.innerText="Raw series:\n"+JSON.stringify(list,null,1);
                    trybutton();
                }
            }
            function trybutton(){
                document.querySelector("button").disabled=filename.length*collection.length===0;
            }
            async function create(){
                document.querySelector("button").disabled=true;
                let series={
                    bucket,
                    atlas:document.getElementById("atlas").value,
                    sections:collection
                };
                if (!filename.endsWith(".json"))
                    filename += ".json";
                let upload = await fetch(`bucket.php?${argspack({filename:filename,put:true})}`).then(response => response.json());
                if (!upload.hasOwnProperty("url")) {
                    document.write("Possible error happened:<br>" + JSON.stringify(upload));
                    return;
                }
                await fetch(upload.url, {
                    method: "PUT",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(series)
                });
                args.filename=filename;
                location.href="webalign.html?"+encodeURIComponent(JSON.stringify(args));
            }
        </script>
    </head>
    <body>
        Enter name of image-chunk collab: <input oninput="trycollect(event)"><br>
        Enter filename:<input id="filename" placeholder="filename.json" oninput="filtername(event)"><br>
        Target atlas:
        <select id="atlas">
            <option value="WHS_SD_Rat_v3_39um">WHS SD Rat v3 39um</option>
            <option value="ABA_Mouse_CCFv3_2017_25um">ABA Mouse CCFv3 2017 25um</option>
        </select><br>
        <button onclick="create()" disabled>Create</button><br>
        <pre id="log"></pre>
    </body>
</html>
