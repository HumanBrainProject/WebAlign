<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script>
            let args=JSON.parse(decodeURIComponent(location.search.substring(1)));
            
            const ext=".waln";
            let filename=ext;
            function filtername(event){
                filename=event.target.value.replaceAll(/[^-\w().!]/g, "");
                let pos=filename.lastIndexOf(".");
                filename=event.target.value=pos>=0?filename.substr(0,pos)+ext:filename+ext;
                trybutton();
            }
            let collecting=false;
            let recollect=false;
            let collection=[];
            let bucket;
            async function trycollect(){
                if(collecting){
                    recollect=true;
                    return;
                }
                prg=document.getElementById("log");

                collecting=true;
                let list=collection=[];
                
                try{
                    bucket=document.getElementById("collab").value.replaceAll(/[^-\w().!]/g, "");
                    let result=await fetch(
                            `https://data-proxy.ebrains.eu/api/v1/buckets/${bucket}?delimiter=/`,{
                                headers:{
                                    accept:"application/json",
                                    authorization:`Bearer ${args.token}`
                                }
                            }
                        ).then(response=>response.json());
                    if(result.hasOwnProperty("objects")){
                        let images=result.objects.filter(item=>item.hasOwnProperty("subdir")&&item.subdir.includes("."));
                        for(let image of images){
                            prg.innerText="Fetching DZI "+(list.length+1)+"/"+images.length;
                            let subdir=image.subdir;
                            let pos=subdir.lastIndexOf(".");
                            let name=subdir.substring(0,pos);
                            let url=await fetch(
                                    `https://data-proxy.ebrains.eu/api/v1/buckets/${bucket}/${subdir+name}.dzi?redirect=false`,{
                                        headers:{
                                            accept:"application/json",
                                            authorization:`Bearer ${args.token}`
                                        }
                                    }
                                ).then(response=>response.json()).then(json=>json.url);
                            let dzi=await fetch(url).then(response=>response.text());
                            list.push({
                                filename:subdir.substring(0,subdir.length-1),
                                width:parseInt(dzi.match(/Width="(\d+)"/m)[1]),
                                height:parseInt(dzi.match(/Height="(\d+)"/m)[1]),
                                tilesize:parseInt(dzi.match(/TileSize="(\d+)"/m)[1]),
                                overlap:parseInt(dzi.match(/Overlap="(\d+)"/m)[1]),
                                format:dzi.match(/Format="([^"]+)"/m)[1]
                            });
                        }
                    }
                }catch(ex){console.log(ex);}
                
                collecting=false;
                if(recollect){
                    recollect=false;
                    trycollect();
                }else{
                    collection=list;
                    prg.innerText="Raw series:\n"+JSON.stringify(list,null,1);
                    trybutton();
                }
            }
            function trybutton(){
                document.querySelector("button").disabled=(filename.length-ext.length)*collection.length===0;
            }
            async function create(){
                document.querySelector("button").disabled=true;
                let series={
                    bucket,
                    atlas:document.getElementById("atlas").value,
                    sections:collection
                };
                let upload=await fetch(
                        `https://data-proxy.ebrains.eu/api/v1/buckets/${args["clb-collab-id"]}/${filename}`,{
                            method: "PUT",
                            headers:{
                                accept:"application/json",
                                authorization:`Bearer ${args.token}`
                            }
                        }
                    ).then(response=>response.json());
                if (!upload.hasOwnProperty("url")) {
                    document.write("Possible error happened:<br>" + JSON.stringify(upload));
                    return;
                }
                await fetch(upload.url, {
                    method: "PUT",
                    headers: {
                        'Content-Type': 'application/x.webalign'
                    },
                    body: JSON.stringify(series)
                });
                args.filename=filename;
                location.href="webalign.html?"+encodeURIComponent(JSON.stringify(args));
            }
            function startup(){
                document.getElementById("collab").value=args["clb-collab-id"];
                const filename=document.getElementById("filename");
                filename.placeholder="filename"+ext;
                filename.value=ext;
                trycollect();
            }
        </script>
    </head>
    <body onload="startup()">
        Enter name of image-chunk collab: <input id="collab" oninput="trycollect()"><br>
        Enter filename:<input id="filename" placeholder="filename.waln" value=".waln" oninput="filtername(event)"><br>
        Target atlas:
        <select id="atlas">
            <option value="WHS_SD_Rat_v3_39um">WHS SD Rat v3 39um</option>
            <option value="ABA_Mouse_CCFv3_2017_25um">ABA Mouse CCFv3 2017 25um</option>
        </select><br>
        <button onclick="create()" disabled>Create</button><br>
        <pre id="log"></pre>
    </body>
</html>
